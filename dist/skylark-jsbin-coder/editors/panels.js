/**
 * skylark-jsbin-coder - A version of jsbin-editor  that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-jsbin-coder/
 * @license MIT
 */
define(["skylark-jquery","skylark-jsbin-base/storage","skylark-jsbin-processors","skylark-jsbin-renderer","../jsbin","./panel"],function(e,t,n,i,s,r){"use strict";var o={};function a(e){var t=["live","javascript","html","css","console"];return e.split(",").reduce(function(e,n){return"js"===n&&(n="javascript"),"output"===n&&(n="live"),-1!==t.indexOf(n)&&e.push(n),e},[])}o.getVisible=function(){var e=this.named,t=[];for(var n in e)e[n].visible&&t.push(e[n]);return t},o.save=function(){if(!s.embed){for(var e,n=this.getVisible(),i={},r="",o=s.$window.width(),a=0;a<n.length;a++)-1===(r=(e=n[a]).$el.css("left")).indexOf("%")&&(r=parseFloat(r)/o*100+"%"),i[e.name]=r;t.sessionStorage.setItem("jsbin.panels",JSON.stringify(i))}},o.restore=function(){var n=window.location,i=n.search.substring(1),r=n.hash.substring(1),l=[],d=s.embed?null:JSON.parse(t.sessionStorage.getItem("jsbin.panels")||"null"),c=o.named.javascript.getCode().length,u=o.named.css.getCode().length,h=o.named.html.getCode().length,f="",g=0,m=null,p=[],v="",b=!1,w=s.$window.width(),y=!!t.sessionStorage.getItem("panel"),j="live javascript html css console".split(" ");if(history.replaceState&&-1!==n.pathname.indexOf("/edit")||(n.origin,n.pathname,s.getURL()),i||r){var C=i||r;-1!==C.indexOf("&")?(C=function(t){var n={},i=/\+/g,s=(t=t.split("&")).length;s>1e3&&(s=1e3);for(var r=0;r<s;++r){var o,a,l,d,c=t[r].replace(i,"%20"),u=c.indexOf("=");u>=0?(o=c.substr(0,u),a=c.substr(u+1)):(o=c,a="");try{l=decodeURIComponent(o),d=decodeURIComponent(a)}catch(e){l=o,d=a}(window.hasOwnProperty?window.hasOwnProperty(n,l):n.hasOwnProperty(l))?e.isArray(n[l])?n[l].push(d):n[l]=[n[l],d]:n[l]=d}return n}(i||r),l=Object.keys(C).reduce(function(e,t){return-1!==t.indexOf(",")&&""===C[t]?e=a(t):("js"===t&&(C.javascript=C.js,t="javascript"),"output"===t&&(C.live=C.live,t="live"),void 0===C[t]&&(C[t]=""),-1!==j.indexOf(t)&&e.push(t+"="+C[t]),e)},[])):l=a(C)}if(0===l.length&&(l=null!==d?Object.keys(d):s.mobile?[s.settings.panels[0]]:s.settings.panels),0===l.length&&(c&&l.push("javascript"),h&&l.push("html"),u&&l.push("css"),l.push("live")),o.saveOnExit=!0,g=0,0===l.length&&(l=["html","live"]),l.length){for(f in d)-1!==l.indexOf(f)&&g++;for(g===l.length&&(b=!0),g=0;g<l.length;g++)v=null,-1!==(f=l[g]).indexOf("=")&&(v=f.substring(f.indexOf("=")+1),f=f.substring(0,f.indexOf("="))),o.named[f]?((m=o.named[f]).editor&&null!==v&&m.setCode(decodeURIComponent(v)),b&&l.length>1?m.show(w*parseFloat(d[f])/100):m.show(),p.push(m)):f&&null!==v&&function(e,t){var n=["html","javascript","css"],i=function(r,a){var l,d,c=o.named[a.panelId]||{};if(a.panelId&&c.editor&&!0===c.ready){n.splice(n.indexOf(a.panelId),1);try{l=c.getCode()}catch(e){}-1!==l.indexOf("%"+e+"%")&&(l=(d=l.split("%"+e+"%"))[0]+decodeURIComponent(t)+d[1],c.setCode(l),s.$document.unbind("codeChange",i))}0===n.length&&s.$document.unbind("codeChange",i)};s.$document.bind("codeChange",i)}(f,v);1===l.length&&"preview"===l[0]&&o.named.live.show(),b||this.distribute()}for(g=0;g<p.length;g++)p[g].init();var x=o.getVisible();x.length&&(s.$body.addClass("panelsVisible"),y||x[0].show())},o.savecontent=function(){var e,n;for(e in this.named)(n=this.named[e]).editor&&t.sessionStorage.setItem("jsbin.content."+e,n.getCode())},o.getHighlightLines=function(){var e,t=[],n="";for(name in o.named)(e=o.named[name]).editor&&(n=e.editor.highlightLines().string)&&t.push(name.substr(0,1).toUpperCase()+":L"+n);return t.join(",")},o.focus=function(t){this.focused=t,t&&e(".panel").removeClass("focus").filter("."+t.id).addClass("focus")},o.getQuery=function(){var e={javascript:"js",live:"output"};return o.getVisible().map(function(t){return e[t.id]||t.id}).join(",")},o.updateQuery=s.throttle(function(){var t=o.getQuery();s.state.code&&s.state.owner&&e.ajax({url:s.getURL({withRevision:!0})+"/settings",type:"PUT",data:{panels:visible.map(function(e){return e.id})},success:function(){}}),history.replaceState&&history.replaceState(null,null,"?"+t)},100);var l=!e("html").hasClass("layout");l||e("#source").removeClass("stretch"),o.distribute=function(){if(l){var t,n=e("#source .panelwrapper:visible"),i=100,r=0,a=s.$window.width()-(n.length-1),d=e("#source").outerHeight(),c=0,u=0,h=0,f=[];if(n.length){s.$body.addClass("panelsVisible"),i=100/n.length;for(var g=0;g<n.length;g++)u=100-i*(g+1),(t=e.data(n[g],"panel")).$el.css({top:0,bottom:0,left:c+"%",right:u+"%"}),t.splitter.trigger("init",a*c/100),t.splitter[0==g?"hide":"show"](),c+=i,(f=e(n[g]).find(".panel")).length>1&&(h=0,f=f.filter(":visible"),r=100/f.length,f.each(function(t){bottom=100-r*(t+1);var n=o.named[e.data(this,"name")];e(this).css("top",h+"%"),e(this).css("bottom",bottom+"%"),n.splitter.hasClass("vertical")&&(n.splitter.trigger("init",d*h/100),n.splitter[0==t?"hide":"show"]()),h+=r}))}else s.embed||(e("#history").show(),setTimeout(function(){s.$body.removeClass("panelsVisible")},100))}},o.show=function(e){this.named[e].show(),this.named[e].editor&&this.named[e].editor.focus(),this.named[e].focus()},o.hide=function(t){e("#history");var n=this.named;n[t].visible&&n[t].hide();var i=n.getVisible();i.length&&(n.focused=i[0],n.focused.editor?n.focused.editor.focus():n.focused.$el.focus(),n.focused.focus())},o.hideAll=function(e){for(var t=o.getVisible(),n=t.length;n--;)t[n].hide(e)},r.prototype.distribute=function(){o.distribute()};var d=function(){return new r("html",{editor:!0,label:"HTML",init:function(){var e=this.editor.getValue().split("\n"),t=-1;e.forEach(function(e,n){-1===t&&0===e.trim().length&&(t=n)}),-1!==t&&(this.editor.setCursor({line:t,ch:2}),0===e[t].length&&this.editor.indentLine(t,"add"))}})},c=function(){return new r("css",{editor:!0,label:"CSS"})},u=function(){return new r("javascript",{editor:!0,label:"JavaScript"})},h=function(){return new r("console",{label:"Console"})},f=function(){return new r("live",{label:"Output",show:function(){o.ready&&w()},hide:function(){o.named.console.visible}})};o.named={};o.named.html=d(),o.named.css=c(),o.named.javascript=u(),o.named.console=h(),o.named.live=f(),o.named.live.settings.render=function(e){o.ready&&w(e)},o.allEditors=function(e){var t,n;for(t in o.named)(n=o.named[t]).editor&&e(n)},setTimeout(function(){o.restore()},10),o.focus(o.getVisible()[0]||null);var g=setInterval(function(){var t,n,i=!0,r=null,a=window.location.hash.substring(1);for(n in o.named)if((t=o.named[n]).visible&&!t.ready){i=!1;break}if(o.ready=i,i){o.allEditors(function(e){var t=e.id.substr(0,1).toUpperCase()+":L";if(-1!==a.indexOf(t)){var n=a.match(new RegExp(t+"(\\d+(?:-\\d+)?)"));null!==n&&e.editor.highlightLines(n[1])}});var l=e("li.add-library"),d=e("li.run-with-js");o.named.live.on("hide",function(){l.show(),d.hide()}),o.named.live.on("show",function(){l.hide(),d.show()}),o.named.live.visible?o.named.live.trigger("show"):o.named.live.trigger("hide"),clearInterval(g),o.named.console.visible?o.named.console.render():w(),s.mobile||e(window).resize(function(){clearTimeout(r),r=setTimeout(function(){s.$document.trigger("sizeeditors")},100)}),s.$document.trigger("sizeeditors"),s.$document.trigger("jsbinReady")}},100);setTimeout(function(){o.restore()},10),o.focus(o.getVisible()[0]||null);var m=function(){o.ready&&o.named.console.render()},p=e("#panels"),v=(e("div.processorSelector").each(function(){var t=this.getAttribute("data-type"),i=e(this),s=i.closest(".label").find("strong a"),r=s.text();i.find("a").click(function(i){var a=o.named[t],l=p.find('a[href$="'+t+'"]');i.preventDefault();var d=this.hash.substring(1),c=e(this).text(),u=e(this).data("label");"convert"!==d?(l.html(u||c),s.html("<span>"+c+"</span>"),d===t?(n.reset(t),m()):n.set(t,d,m)):(s.text(r),l.html(r),a.render().then(function(e){n.reset(t),a.setCode(e)}))}).bind("select",function(n,i){if(i===this.hash.substring(1)){var r=p.find('a[href$="'+t+'"]'),o=e(this);s.html("<span>"+o.text()+"</span>"),r.html(o.data("label")||o.text())}})}),n.set);n.set=function(e,t,n){var i;i=e instanceof r?e:o.named[e],v(i,t,n)},n.reset=function(e){n.set(e)};var b=o.getRenderedCode=function(){!0;var e=["html","javascript","css"].reduce(function(e,t){return(!s.owner()||o.focused&&t===o.focused.id)&&(b[t]=b.render(t)),e.push(b[t]),e},[]);return Promise.all(e).then(function(e){return{html:e[0],javascript:e[1],css:e[2]}}).catch(function(e){})};b.render=function(t){return new Promise(function(n,i){o.named[t].render().then(n,function(n){if(console.warn(o.named[t].processor.id+" processor compilation failed"),n||(n={}),e.isArray(n)){var s=o.named[t].editor;if(void 0!==s.updateLinting){hintingDone(s);var r=function(e){for(var t=[],n=0,i=0,s=0;s<e.length;s++)n=e[s].line||0,i=e[s].ch||0,t.push({from:{line:n,ch:i},to:{line:n,ch:i},message:e[s].msg,severity:"error"});return t}(n);s.updateLinting(r)}else console.warn(n)}else n.message?console.warn(n.message,n.stack):console.warn(n);i(n)})})};var w=o.renderLivePreview=function(n){window.postMessage&&(n&&(s.saveChecksum&&e.ajax({url:s.getURL()+"/reload",data:{code:s.state.code,revision:s.state.revision,checksum:s.saveChecksum},type:"post"}),s.state.hasBody=!1),b().then(function(e){s.settings.includejs;var r=o.getVisible(),a=r.indexOf(o.named.live)>-1,l=r.indexOf(o.named.console)>-1;(a||l)&&(s.settings.includejs&&t.sessionStorage.setItem("runnerPending",1),i.postMessage("render",{codes:e,options:{injectCSS:s.state.hasBody&&"css"===o.focused.id,requested:n,debug:s.settings.debug,includeJsInRealtime:s.settings.includejs}}),s.state.hasBody=!0)}))};return s.coder.editors.panels=o});
//# sourceMappingURL=../sourcemaps/editors/panels.js.map
