/**
 * skylark-jsbin-coder - A version of jsbin-editor  that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-jsbin-coder/
 * @license MIT
 */
define(["skylark-jquery","skylark-jsbin-base/storage","skylark-jsbin-processors","../jsbin","./panel"],function(e,t,i,n,s){var o={};function r(e){var t=["live","javascript","html","css","console"];return e.split(",").reduce(function(e,i){return"js"===i&&(i="javascript"),"output"===i&&(i="live"),-1!==t.indexOf(i)&&e.push(i),e},[])}o.getVisible=function(){var e=this.named,t=[];for(var i in e)e[i].visible&&t.push(e[i]);return t},o.save=function(){if(!n.embed){for(var i,s=this.getVisible(),o={},r="",a=e(window).width(),l=0;l<s.length;l++)-1===(r=(i=s[l]).$el.css("left")).indexOf("%")&&(r=parseFloat(r)/a*100+"%"),o[i.name]=r;t.sessionStorage.setItem("jsbin.panels",JSON.stringify(o))}},o.restore=function(){"use strict";var i=window.location,s=i.search.substring(1),a=i.hash.substring(1),l=[],d=n.embed?null:JSON.parse(t.sessionStorage.getItem("jsbin.panels")||"null"),c=f.javascript.getCode().length,u=f.css.getCode().length,h=f.html.getCode().length,p="",g=0,v=null,m=[],b="",w=!1,y=$window.width(),j=!!t.sessionStorage.getItem("panel"),O="live javascript html css console".split(" ");if(history.replaceState&&-1!==i.pathname.indexOf("/edit")||(i.origin,i.pathname,n.getURL()),s||a){var C=s||a;-1!==C.indexOf("&")?(C=function(t){var i={},n=/\+/g,s=(t=t.split("&")).length;s>1e3&&(s=1e3);for(var o=0;o<s;++o){var r,a,l,d,c=t[o].replace(n,"%20"),u=c.indexOf("=");u>=0?(r=c.substr(0,u),a=c.substr(u+1)):(r=c,a="");try{l=decodeURIComponent(r),d=decodeURIComponent(a)}catch(e){l=r,d=a}(window.hasOwnProperty?window.hasOwnProperty(i,l):i.hasOwnProperty(l))?e.isArray(i[l])?i[l].push(d):i[l]=[i[l],d]:i[l]=d}return i}(s||a),l=Object.keys(C).reduce(function(e,t){return-1!==t.indexOf(",")&&""===C[t]?e=r(t):("js"===t&&(C.javascript=C.js,t="javascript"),"output"===t&&(C.live=C.live,t="live"),void 0===C[t]&&(C[t]=""),-1!==O.indexOf(t)&&e.push(t+"="+C[t]),e)},[])):l=r(C)}if(0===l.length&&(l=null!==d?Object.keys(d):n.mobile?[n.settings.panels[0]]:n.settings.panels),0===l.length&&(c&&l.push("javascript"),h&&l.push("html"),u&&l.push("css"),l.push("live")),o.saveOnExit=!0,g=0,0===l.length&&(l=["html","live"]),l.length){for(p in d)-1!==l.indexOf(p)&&g++;for(g===l.length&&(w=!0),g=0;g<l.length;g++)b=null,-1!==(p=l[g]).indexOf("=")&&(b=p.substring(p.indexOf("=")+1),p=p.substring(0,p.indexOf("="))),o.named[p]?((v=o.named[p]).editor&&null!==b&&v.setCode(decodeURIComponent(b)),w&&l.length>1?v.show(y*parseFloat(d[p])/100):v.show(),m.push(v)):p&&null!==b&&function(e,t){var i=["html","javascript","css"],n=function(s,r){var a,l,d=o.named[r.panelId]||{};if(r.panelId&&d.editor&&!0===d.ready){i.splice(i.indexOf(r.panelId),1);try{a=d.getCode()}catch(e){}-1!==a.indexOf("%"+e+"%")&&(a=(l=a.split("%"+e+"%"))[0]+decodeURIComponent(t)+l[1],d.setCode(a),$document.unbind("codeChange",n))}0===i.length&&$document.unbind("codeChange",n)};$document.bind("codeChange",n)}(p,b);1===l.length&&"preview"===l[0]&&o.named.live.show(),w||this.distribute()}for(g=0;g<m.length;g++)m[g].init();var x=o.getVisible();x.length&&($body.addClass("panelsVisible"),j||x[0].show())},o.savecontent=function(){var e,i;for(e in this.named)(i=this.named[e]).editor&&t.sessionStorage.setItem("jsbin.content."+e,i.getCode())},o.getHighlightLines=function(){"use strict";var e,t=[],i="";for(name in o.named)(e=o.named[name]).editor&&(i=e.editor.highlightLines().string)&&t.push(name.substr(0,1).toUpperCase()+":L"+i);return t.join(",")},o.focus=function(t){this.focused=t,t&&e(".panel").removeClass("focus").filter("."+t.id).addClass("focus")},o.getQuery=function(){var e={javascript:"js",live:"output"};return o.getVisible().map(function(t){return e[t.id]||t.id}).join(",")},o.updateQuery=n.throttle(function(){var t=o.getQuery();n.state.code&&n.state.owner&&e.ajax({url:n.getURL({withRevision:!0})+"/settings",type:"PUT",data:{panels:visible.map(function(e){return e.id})},success:function(){}}),history.replaceState&&history.replaceState(null,null,"?"+t)},100);var a=!e("html").hasClass("layout");a||e("#source").removeClass("stretch"),o.distribute=function(){if(a){var t,i=e("#source .panelwrapper:visible"),s=100,r=0,l=$window.width()-(i.length-1),d=e("#source").outerHeight(),c=0,u=0,h=0,f=[];if(i.length){$body.addClass("panelsVisible"),s=100/i.length;for(var p=0;p<i.length;p++)u=100-s*(p+1),(t=e.data(i[p],"panel")).$el.css({top:0,bottom:0,left:c+"%",right:u+"%"}),t.splitter.trigger("init",l*c/100),t.splitter[0==p?"hide":"show"](),c+=s,(f=e(i[p]).find(".panel")).length>1&&(h=0,f=f.filter(":visible"),r=100/f.length,f.each(function(t){bottom=100-r*(t+1);var i=o.named[e.data(this,"name")];e(this).css("top",h+"%"),e(this).css("bottom",bottom+"%"),i.splitter.hasClass("vertical")&&(i.splitter.trigger("init",d*h/100),i.splitter[0==t?"hide":"show"]()),h+=r}))}else n.embed||(e("#history").show(),setTimeout(function(){$body.removeClass("panelsVisible")},100))}},o.show=function(e){this.named[e].show(),this.named[e].editor&&this.named[e].editor.focus(),this.named[e].focus()},o.hide=function(t){e("#history");var i=this.named;i[t].visible&&i[t].hide();var n=i.getVisible();n.length&&(i.focused=n[0],i.focused.editor?i.focused.editor.focus():i.focused.$el.focus(),i.focused.focus())},o.hideAll=function(e){for(var t=o.getVisible(),i=t.length;i--;)t[i].hide(e)},s.prototype.distribute=function(){o.distribute()};var l=function(){return new s("html",{editor:!0,label:"HTML",init:function(){var e=this.editor.getValue().split("\n"),t=-1;e.forEach(function(e,i){-1===t&&0===e.trim().length&&(t=i)}),-1!==t&&(this.editor.setCursor({line:t,ch:2}),0===e[t].length&&this.editor.indentLine(t,"add"))}})},d=function(){return new s("css",{editor:!0,label:"CSS"})},c=function(){return new s("javascript",{editor:!0,label:"JavaScript"})},u=function(){return new s("console",{label:"Console"})},h=function(){return new s("live",{label:"Output",show:function(){o.ready&&renderLivePreview()},hide:function(){o.named.console.visible}})},f=o.named={};f.html=l(),f.css=d(),f.javascript=c(),f.console=u(),upgradeConsolePanel(f.console),f.live=h(),f.live.settings.render=function(e){o.ready&&renderLivePreview(e)},o.allEditors=function(e){var t,i;for(t in o.named)(i=o.named[t]).editor&&e(i)},setTimeout(function(){o.restore()},10),o.focus(o.getVisible()[0]||null);var p=setInterval(function(){var t,i,s=!0,r=null,a=window.location.hash.substring(1);for(i in o.named)if((t=o.named[i]).visible&&!t.ready){s=!1;break}if(o.ready=s,s){o.allEditors(function(e){var t=e.id.substr(0,1).toUpperCase()+":L";if(-1!==a.indexOf(t)){var i=a.match(new RegExp(t+"(\\d+(?:-\\d+)?)"));null!==i&&e.editor.highlightLines(i[1])}});var l=e("li.add-library"),d=e("li.run-with-js");f.live.on("hide",function(){l.show(),d.hide()}),f.live.on("show",function(){l.hide(),d.show()}),o.named.live.visible?f.live.trigger("show"):f.live.trigger("hide"),clearInterval(p),o.named.console.visible?f.console.render():renderLivePreview(),n.mobile||e(window).resize(function(){clearTimeout(r),r=setTimeout(function(){$document.trigger("sizeeditors")},100)}),$document.trigger("sizeeditors"),$document.trigger("jsbinReady")}},100);setTimeout(function(){o.restore()},10),o.focus(o.getVisible()[0]||null);var g=function(){n.panels.ready&&f.console.render()},v=e("#panels"),m=e("div.processorSelector").each(function(){var t=this.getAttribute("data-type"),s=e(this),o=s.closest(".label").find("strong a"),r=o.text();s.find("a").click(function(s){var a=n.panels.named[t],l=v.find('a[href$="'+t+'"]');s.preventDefault();var d=this.hash.substring(1),c=e(this).text(),u=e(this).data("label");"convert"!==d?(l.html(u||c),o.html("<span>"+c+"</span>"),d===t?(i.reset(t),g()):i.set(t,d,g)):(o.text(r),l.html(r),a.render().then(function(e){i.reset(t),a.setCode(e)}))}).bind("select",function(i,n){if(n===this.hash.substring(1)){var s=v.find('a[href$="'+t+'"]'),r=e(this);o.html("<span>"+r.text()+"</span>"),s.html(r.data("label")||r.text())}})});return i.set=function(e,t,o){var r;e instanceof s?e=(r=e).id:r=n.panels.named[e],n.state.processors||(n.state.processors={});var a=t&&editorModes[t]||editorModes[e],l="jsx"!==t;if(r){r.trigger("processor",t||"none"),t&&i[t]?(n.state.processors[e]=t,r.processor=i[t](function(){r.editor.setOption("mode",a),r.editor.setOption("smartIndent",l),m.find("a").trigger("select",[t]),o&&o()})):(r.editor.setOption("mode",a),r.editor.setOption("smartIndent",l),r.processor=defaultProcessor,n.state.processors[e]=e,delete r.type);var d=a;"javascript"===a&&(d="js"),"htmlmixed"===a&&(d="html"),r.editor.getOption("lint")&&r.editor.lintStop(),n.settings[d+"hint"]&&(r.editor.setOption("mode",a),"undefined"!=typeof hintingDone&&(r.editor.setOption("mode",a),hintingDone(r.editor)))}},i.reset=function(e){i.set(e)},n.codepan.panels=o});
//# sourceMappingURL=../sourcemaps/editors/panels.js.map
