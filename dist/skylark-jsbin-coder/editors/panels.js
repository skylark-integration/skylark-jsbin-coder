/**
 * skylark-jsbin-coder - A version of jsbin-editor  that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-jsbin-coder/
 * @license MIT
 */
define(["skylark-jquery","skylark-jsbin-base/storage","skylark-jsbin-processors","../jsbin","./panel"],function(e,t,n,i,s){"use strict";var r={};function o(e){var t=["live","javascript","html","css","console"];return e.split(",").reduce(function(e,n){return"js"===n&&(n="javascript"),"output"===n&&(n="live"),-1!==t.indexOf(n)&&e.push(n),e},[])}r.getVisible=function(){var e=this.named,t=[];for(var n in e)e[n].visible&&t.push(e[n]);return t},r.save=function(){if(!i.embed){for(var e,n=this.getVisible(),s={},r="",o=i.$window.width(),a=0;a<n.length;a++)-1===(r=(e=n[a]).$el.css("left")).indexOf("%")&&(r=parseFloat(r)/o*100+"%"),s[e.name]=r;t.sessionStorage.setItem("jsbin.panels",JSON.stringify(s))}},r.restore=function(){var n=window.location,s=n.search.substring(1),a=n.hash.substring(1),l=[],d=i.embed?null:JSON.parse(t.sessionStorage.getItem("jsbin.panels")||"null"),u=r.named.javascript.getCode().length,c=r.named.css.getCode().length,h=r.named.html.getCode().length,f="",p=0,v=null,g=[],m="",b=!1,w=i.$window.width(),y=!!t.sessionStorage.getItem("panel"),j="live javascript html css console".split(" ");if(history.replaceState&&-1!==n.pathname.indexOf("/edit")||(n.origin,n.pathname,i.getURL()),s||a){var C=s||a;-1!==C.indexOf("&")?(C=function(t){var n={},i=/\+/g,s=(t=t.split("&")).length;s>1e3&&(s=1e3);for(var r=0;r<s;++r){var o,a,l,d,u=t[r].replace(i,"%20"),c=u.indexOf("=");c>=0?(o=u.substr(0,c),a=u.substr(c+1)):(o=u,a="");try{l=decodeURIComponent(o),d=decodeURIComponent(a)}catch(e){l=o,d=a}(window.hasOwnProperty?window.hasOwnProperty(n,l):n.hasOwnProperty(l))?e.isArray(n[l])?n[l].push(d):n[l]=[n[l],d]:n[l]=d}return n}(s||a),l=Object.keys(C).reduce(function(e,t){return-1!==t.indexOf(",")&&""===C[t]?e=o(t):("js"===t&&(C.javascript=C.js,t="javascript"),"output"===t&&(C.live=C.live,t="live"),void 0===C[t]&&(C[t]=""),-1!==j.indexOf(t)&&e.push(t+"="+C[t]),e)},[])):l=o(C)}if(0===l.length&&(l=null!==d?Object.keys(d):i.mobile?[i.settings.panels[0]]:i.settings.panels),0===l.length&&(u&&l.push("javascript"),h&&l.push("html"),c&&l.push("css"),l.push("live")),r.saveOnExit=!0,p=0,0===l.length&&(l=["html","live"]),l.length){for(f in d)-1!==l.indexOf(f)&&p++;for(p===l.length&&(b=!0),p=0;p<l.length;p++)m=null,-1!==(f=l[p]).indexOf("=")&&(m=f.substring(f.indexOf("=")+1),f=f.substring(0,f.indexOf("="))),r.named[f]?((v=r.named[f]).editor&&null!==m&&v.setCode(decodeURIComponent(m)),b&&l.length>1?v.show(w*parseFloat(d[f])/100):v.show(),g.push(v)):f&&null!==m&&function(e,t){var n=["html","javascript","css"],s=function(o,a){var l,d,u=r.named[a.panelId]||{};if(a.panelId&&u.editor&&!0===u.ready){n.splice(n.indexOf(a.panelId),1);try{l=u.getCode()}catch(e){}-1!==l.indexOf("%"+e+"%")&&(l=(d=l.split("%"+e+"%"))[0]+decodeURIComponent(t)+d[1],u.setCode(l),i.$document.unbind("codeChange",s))}0===n.length&&i.$document.unbind("codeChange",s)};i.$document.bind("codeChange",s)}(f,m);1===l.length&&"preview"===l[0]&&r.named.live.show(),b||this.distribute()}for(p=0;p<g.length;p++)g[p].init();var O=r.getVisible();O.length&&($body.addClass("panelsVisible"),y||O[0].show())},r.savecontent=function(){var e,n;for(e in this.named)(n=this.named[e]).editor&&t.sessionStorage.setItem("jsbin.content."+e,n.getCode())},r.getHighlightLines=function(){var e,t=[],n="";for(name in r.named)(e=r.named[name]).editor&&(n=e.editor.highlightLines().string)&&t.push(name.substr(0,1).toUpperCase()+":L"+n);return t.join(",")},r.focus=function(t){this.focused=t,t&&e(".panel").removeClass("focus").filter("."+t.id).addClass("focus")},r.getQuery=function(){var e={javascript:"js",live:"output"};return r.getVisible().map(function(t){return e[t.id]||t.id}).join(",")},r.updateQuery=i.throttle(function(){var t=r.getQuery();i.state.code&&i.state.owner&&e.ajax({url:i.getURL({withRevision:!0})+"/settings",type:"PUT",data:{panels:visible.map(function(e){return e.id})},success:function(){}}),history.replaceState&&history.replaceState(null,null,"?"+t)},100);var a=!e("html").hasClass("layout");a||e("#source").removeClass("stretch"),r.distribute=function(){if(a){var t,n=e("#source .panelwrapper:visible"),s=100,o=0,l=i.$window.width()-(n.length-1),d=e("#source").outerHeight(),u=0,c=0,h=0,f=[];if(n.length){$body.addClass("panelsVisible"),s=100/n.length;for(var p=0;p<n.length;p++)c=100-s*(p+1),(t=e.data(n[p],"panel")).$el.css({top:0,bottom:0,left:u+"%",right:c+"%"}),t.splitter.trigger("init",l*u/100),t.splitter[0==p?"hide":"show"](),u+=s,(f=e(n[p]).find(".panel")).length>1&&(h=0,f=f.filter(":visible"),o=100/f.length,f.each(function(t){bottom=100-o*(t+1);var n=r.named[e.data(this,"name")];e(this).css("top",h+"%"),e(this).css("bottom",bottom+"%"),n.splitter.hasClass("vertical")&&(n.splitter.trigger("init",d*h/100),n.splitter[0==t?"hide":"show"]()),h+=o}))}else i.embed||(e("#history").show(),setTimeout(function(){$body.removeClass("panelsVisible")},100))}},r.show=function(e){this.named[e].show(),this.named[e].editor&&this.named[e].editor.focus(),this.named[e].focus()},r.hide=function(t){e("#history");var n=this.named;n[t].visible&&n[t].hide();var i=n.getVisible();i.length&&(n.focused=i[0],n.focused.editor?n.focused.editor.focus():n.focused.$el.focus(),n.focused.focus())},r.hideAll=function(e){for(var t=r.getVisible(),n=t.length;n--;)t[n].hide(e)},s.prototype.distribute=function(){r.distribute()};var l=function(){return new s("html",{editor:!0,label:"HTML",init:function(){var e=this.editor.getValue().split("\n"),t=-1;e.forEach(function(e,n){-1===t&&0===e.trim().length&&(t=n)}),-1!==t&&(this.editor.setCursor({line:t,ch:2}),0===e[t].length&&this.editor.indentLine(t,"add"))}})},d=function(){return new s("css",{editor:!0,label:"CSS"})},u=function(){return new s("javascript",{editor:!0,label:"JavaScript"})},c=function(){return new s("console",{label:"Console"})},h=function(){return new s("live",{label:"Output",show:function(){r.ready&&renderLivePreview()},hide:function(){r.named.console.visible}})},f=r.named={};r.named.html=l(),r.named.css=d(),r.named.javascript=u(),r.named.console=c(),f.live=h(),f.live.settings.render=function(e){r.ready&&renderLivePreview(e)},r.allEditors=function(e){var t,n;for(t in r.named)(n=r.named[t]).editor&&e(n)},setTimeout(function(){r.restore()},10),r.focus(r.getVisible()[0]||null);var p=setInterval(function(){var t,n,s=!0,o=null,a=window.location.hash.substring(1);for(n in r.named)if((t=r.named[n]).visible&&!t.ready){s=!1;break}if(r.ready=s,s){r.allEditors(function(e){var t=e.id.substr(0,1).toUpperCase()+":L";if(-1!==a.indexOf(t)){var n=a.match(new RegExp(t+"(\\d+(?:-\\d+)?)"));null!==n&&e.editor.highlightLines(n[1])}});var l=e("li.add-library"),d=e("li.run-with-js");r.named.live.on("hide",function(){l.show(),d.hide()}),r.named.live.on("show",function(){l.hide(),d.show()}),r.named.live.visible?r.named.live.trigger("show"):r.named.live.trigger("hide"),clearInterval(p),r.named.console.visible?r.named.console.render():renderLivePreview(),i.mobile||e(window).resize(function(){clearTimeout(o),o=setTimeout(function(){i.$document.trigger("sizeeditors")},100)}),i.$document.trigger("sizeeditors"),i.$document.trigger("jsbinReady")}},100);setTimeout(function(){r.restore()},10),r.focus(r.getVisible()[0]||null);var v=function(){i.panels.ready&&r.named.console.render()},g=e("#panels"),m=(e("div.processorSelector").each(function(){var t=this.getAttribute("data-type"),s=e(this),r=s.closest(".label").find("strong a"),o=r.text();s.find("a").click(function(s){var a=i.panels.named[t],l=g.find('a[href$="'+t+'"]');s.preventDefault();var d=this.hash.substring(1),u=e(this).text(),c=e(this).data("label");"convert"!==d?(l.html(c||u),r.html("<span>"+u+"</span>"),d===t?(n.reset(t),v()):n.set(t,d,v)):(r.text(o),l.html(o),a.render().then(function(e){n.reset(t),a.setCode(e)}))}).bind("select",function(n,i){if(i===this.hash.substring(1)){var s=g.find('a[href$="'+t+'"]'),o=e(this);r.html("<span>"+o.text()+"</span>"),s.html(o.data("label")||o.text())}})}),n.set);return n.set=function(e,t,n){var r;r=e instanceof s?e:i.panels.named[e],m(r,t,n)},n.reset=function(e){n.set(e)},i.coder.panels=r});
//# sourceMappingURL=../sourcemaps/editors/panels.js.map
