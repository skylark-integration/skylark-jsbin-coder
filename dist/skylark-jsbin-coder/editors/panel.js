/**
 * skylark-jsbin-coder - A version of jsbin-editor  that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-jsbin-coder/
 * @license MIT
 */
define(["skylark-jquery","skylark-jsbin-base/storage","skylark-jsbin-processors","skylark-jsbin-chrome/hideOpen","../jsbin","../coder","./codemirror","./snippets.cm","../chrome/splitter"],function(e,t,s,i,o,r,n){var a=e(document),l=e("#source"),d=!e("html").hasClass("layout"),c={html:"htmlmixed",javascript:"javascript",css:"css",typescript:"javascript",markdown:"markdown",coffeescript:"coffeescript",livescript:"text/x-livescript",jsx:"javascript",less:"text/x-less",sass:"text/x-sass",scss:"text/x-scss",processing:"text/x-csrc",jade:"text/x-jade",clojurescript:"clojure"},p=new RegExp("[​- ]","g");"default"===o.settings.editor.tabMode?n.keyMap.basic.Tab=void 0:"classic"!==o.settings.editor.tabMode&&(n.keyMap.basic.Tab="indentMore"),n.commands||(n.commands={});n.commands.autocomplete=function(e){if(n.snippets(e)===n.Pass)return n.simpleHint(e,n.hint.javascript)},n.commands.snippets=function(e){"use strict";return-1===["htmlmixed","javascript","css",c.less,c.sass,c.scss].indexOf(e.options.mode)?n.simpleHint(e,n.hint.anyword):oldCodeMirror?oldCodeMirror.snippets(e):o.mobile?void 0:n.snippets(e)};var h=function(t,i){"use strict";var r=this,d=null,p={},u=t,g=e('<div class="stretch panelwrapper"></div>');if(r.settings=i=i||{},r.id=r.name=t,(d=e(".panel."+t)).data("name",t),r.$el=d.detach(),r.$el.appendTo(g),g.appendTo(l),r.$panel=r.$el,r.$el=r.$el.parent().hide(),r.el=document.getElementById(t),r.order=++h.order,r.label=i.label||t,r.$el.data("panel",r),this._eventHandlers={},r.on("show",panels.updateQuery),r.on("hide",panels.updateQuery),1===r.order&&(i.nosplitter=!0),i.editor){if(p={parserfile:[],readOnly:!!o.state.embed&&"nocursor",dragDrop:!1,mode:c[u],lineWrapping:!1,theme:o.settings.theme||"jsbin",highlightLine:!0},e.extend(p,o.settings.editor||{}),p.extraKeys={},p.extraKeys.Tab="javascript"===t?"autocomplete":"snippets","html"===t&&e.extend(p,{syntax:t,profile:t}),"string"==typeof p.tabSize&&(p.tabSize=parseInt(p.tabSize,10)||2),"string"==typeof p.indentUnit&&(p.indentUnit=parseInt(p.indentUnit,10)||2),r.editor=n.fromTextArea(r.el,p),r.editor.on("highlightLines",function(){window.location.hash=panels.getHighlightLines()}),r.editor.on("change",function(e,t){return o.saveDisabled?a.trigger("codeChange.live",[{panelId:r.id,revert:!0,origin:t.origin}]):a.trigger("codeChange",[{panelId:r.id,revert:!0,origin:t.origin}]),!0}),r.editor.on("focus",function(){r.focus()}),"javascript"===t){var f="mac"===e.browser.platform?"Cmd":"Ctrl",m={};m[f+"-D"]="deleteLine",m[f+"-/"]=function(e){n.commands.toggleComment(e)},m.name="noEmmet",r.editor.addKeyMap(m)}r._setupEditor(r.editor,t)}e("html").is(".layout")?(r.splitter=e(),r.$el.removeClass("stretch")):i.nosplitter?r.splitter=e():(r.splitter=r.$el.splitter({}).data("splitter"),r.splitter.hide()),o.state.processors&&o.state.processors[t]?(u=o.state.processors[t],s.set(r,o.state.processors[t])):i.processor?(u=i.processors[i.processor],s.set(r,i.processor)):s[r.id]?s.set(r,r.id):r.processor=function(e){return new Promise(function(t){t(e)})},i.beforeRender&&a.bind("render",e.proxy(i.beforeRender,r)),i.editor||(r.ready=!0),o.state.embed,this.controlButton=e('<a role="button" class="button group" href="?'+t+'">'+r.label+"</a>"),this.updateAriaState(),this.controlButton.on("click touchstart",function(){return r.toggle(),!1}),this.controlButton.appendTo("#panels"),d.focus(function(){r.focus()}),o.mobile||d.add(this.$el.find(".label")).click(function(){r.focus()})};function u(e,s){if(e.codeSet)l=!0;else{var i=t.sessionStorage.getItem("jsbin.content."+s),r=o.embed?null:t.localStorage.getItem("saved-"+s),n=t.sessionStorage.getItem("url"),l=!1;if(n===o.getURL()||o.state.checksum||(t.sessionStorage.removeItem("checksum"),o.saveChecksum=!1),template&&i==template[s])e.setCode(i);else if(i&&n==o.getURL()&&n!==o.root)e.setCode(i),l=i!=r&&i!=template[s];else if(template.post||null===r||/(edit|embed)$/.test(window.location)||window.location.search)e.setCode(template[s]);else{e.setCode(r);var d=JSON.parse(t.localStorage.getItem("saved-processors")||"{}")[s];d&&o.processors.set(o.panels.panels[s],d)}e.editor&&e.editor.clearHistory&&e.editor.clearHistory()}l&&a.trigger("codeChange",[{revert:!1,onload:!0}])}return h.order=0,h.prototype={virgin:!0,visible:!1,updateAriaState:function(){this.controlButton.attr("aria-label",this.label+" Panel: "+(this.visible?"Active":"Inactive"))},show:function(t){if(i(),!this.visible){a.trigger("history:close");var s=this,r=s.$el.find(".panel").length;if(analytics.showPanel(s.id),o.mobile&&panels.hideAll(!0),s.splitter.length){if(0===r||r>1)e(".panel."+s.id).show().closest(".panelwrapper").show();else s.$el.show();s.splitter.show()}else s.$el.show();if($body.addClass("panelsVisible"),s.settings.show&&s.settings.show.call(s,!0),s.controlButton.addClass("active"),s.visible=!0,this.updateAriaState(),o.mobile&&window.matchMedia&&window.matchMedia("(max-height: 410px) and (max-width: 640px)").matches&&s.editor&&s.editor.focus(),o.mobile)return s.focus(),void s.trigger("show");setTimeout(function(){if(d&&(void 0!==t?s.splitter.trigger("init",t):s.distribute()),s.editor){if(s.virgin){var i=s.$el.find(".label").outerHeight();i+=8,o.mobile||e(s.editor.scroller).find(".CodeMirror-lines").css("padding-top",i),u(s,s.name)}s.virgin&&!o.panels.ready||(s.editor.focus(),s.focus()),s.virgin&&s.settings.init&&setTimeout(function(){s.settings.init.call(s)},10)}else s.focus();a.trigger("sizeeditors"),s.trigger("show"),s.virgin=!1},0)}},hide:function(t){this.visible=!1,this.updateAriaState(),t?this.editor&&(getRenderedCode[this.id]=getRenderedCode.render(this.id)):analytics.hidePanel(this.id);var s=this.$el.find(".panel").length;if(0===s||s>1){var i=e(".panel."+this.id).hide();i.prev().hide(),0===i.closest(".panelwrapper").find(".panel:visible").length&&i.closest(".panelwrapper").hide()}else this.$el.hide(),this.splitter.hide();this.editor&&this.controlButton.toggleClass("hasContent",!!this.getCode().trim().length),this.controlButton.removeClass("active"),this.settings.hide&&this.settings.hide.call(this,!0);var r=o.panels.getVisible();r.length&&(o.panels.focused=r[0],o.panels.focused.editor?o.panels.focused.editor.focus():o.panels.focused.$el.focus(),o.panels.focused.focus()),!t&&o.mobile&&0===r.length&&(a.trigger("history:load"),e("#history").show(),setTimeout(function(){$body.removeClass("panelsVisible")},100)),this.trigger("hide"),t||(this.distribute(),a.trigger("sizeeditors"),a.trigger("history:open"))},toggle:function(){this[this.visible?"hide":"show"]()},getCode:function(){if(this.editor)return p.lastIndex=0,this.editor.getCode().replace(p,"")},setCode:function(e){this.editor&&(void 0===e&&(e=""),this.controlButton.toggleClass("hasContent",!!e.trim().length),this.codeSet=!0,this.editor.setCode(e.replace(p,"")))},codeSet:!1,blur:function(){this.$panel.addClass("blur")},focus:function(){this.$panel.removeClass("blur"),o.panels.focus(this)},render:function(){"use strict";var e=[].slice.call(arguments),t=this;return new Promise(function(s,i){t.editor?t.processor(t.getCode()).then(s,i):t.visible&&t.settings.render&&(o.panels.ready&&t.settings.render.apply(t,e),s())})},init:function(){this.settings.init&&this.settings.init.call(this)},_setupEditor:function(){var s=t.sessionStorage.getItem("panel")||o.settings.focusedPanel,i=this,r=i.editor;r.setCode=function(e){try{r.setValue(e)}catch(e){}},r.getCode=function(){return r.getValue()},r.currentLine=function(){return r.getCursor().line},o.embed&&(r._focus=r.focus,r.focus=function(){}),r.id=i.name,r.win=r.getWrapperElement(),r.scroller=e(r.getScrollerElement());var n=i.$el.find(".label");-1===document.body.className.indexOf("ie6")&&n.length&&r.on("scroll",function(t){r.getScrollInfo().top>10?n.stop().animate({opacity:0},20,function(){e(this).hide()}):n.show().stop().animate({opacity:1},150)});a.bind("sizeeditors",function(){if(i.visible){var e=i.editor.scroller.closest(".panel").outerHeight(),t=0;t+=i.$el.find("details").filter(":visible").height()||0,o.lameEditor||r.scroller.height(e-t);try{r.refresh()}catch(e){}setTimeout(function(){l[0].style.paddingLeft="1px",setTimeout(function(){l[0].style.paddingLeft="0"},0)},0)}}),setTimeout(function(){i.ready=!0,u(i,i.name),s==i.name&&setTimeout(function(){if(i.focus(),i.visible&&!o.mobile&&!o.tablet){r.focus();for(var e=r.getCode().split("\n"),s=null,n=0;n<e.length;n++)if(null===s&&""===e[n].trim()){s=n;break}r.setCursor({line:1*(t.sessionStorage.getItem("line")||s||0),ch:1*(t.sessionStorage.getItem("character")||0)})}},110)},0)},populateEditor:function(){u(this,this.name)},on:function(e,t){return(this._eventHandlers[e]=this._eventHandlers[e]||[]).push(t),this},trigger:function(e){var t=[].slice.call(arguments,1);t.unshift({type:e});for(var s=this._eventHandlers[e],i=0;s&&s[i];)s[i++].apply(this,t);return this}},s.set=function(t,i,r){var n=t.id;o.state.processors||(o.state.processors={});var a=i&&c[i]||c[n],l="jsx"!==i;if(t){t.trigger("processor",i||"none"),i&&s[i]?(o.state.processors[n]=i,t.processor=s[i](function(){t.editor.setOption("mode",a),t.editor.setOption("smartIndent",l),e("div.processorSelector").find("a").trigger("select",[i]),r&&r()})):(t.editor.setOption("mode",a),t.editor.setOption("smartIndent",l),t.processor=defaultProcessor,o.state.processors[n]=n,delete t.type);var d=a;"javascript"===a&&(d="js"),"htmlmixed"===a&&(d="html"),t.editor.getOption("lint")&&t.editor.lintStop(),o.settings[d+"hint"]&&(t.editor.setOption("mode",a),"undefined"!=typeof hintingDone&&(t.editor.setOption("mode",a),hintingDone(t.editor)))}},r.editors.Panel=h});
//# sourceMappingURL=../sourcemaps/editors/panel.js.map
