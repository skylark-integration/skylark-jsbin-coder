/**
 * skylark-jsbin-coder - A version of jsbin-editor  that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-jsbin-coder/
 * @license MIT
 */
define(["skylark-jquery","skylark-jsbin-base/storage","../jsbin","../coder","./codemirror","./snippets.cm"],function(e,t,s,i,o){var r=e(document),n=e("#source"),a=!e("html").hasClass("layout"),l={html:"htmlmixed",javascript:"javascript",css:"css",typescript:"javascript",markdown:"markdown",coffeescript:"coffeescript",livescript:"text/x-livescript",jsx:"javascript",less:"text/x-less",sass:"text/x-sass",scss:"text/x-scss",processing:"text/x-csrc",jade:"text/x-jade",clojurescript:"clojure"},d=new RegExp("[​- ]","g");"default"===s.settings.editor.tabMode?o.keyMap.basic.Tab=void 0:"classic"!==s.settings.editor.tabMode&&(o.keyMap.basic.Tab="indentMore"),o.commands||(o.commands={});o.commands.autocomplete=function(e){if(o.snippets(e)===o.Pass)return o.simpleHint(e,o.hint.javascript)},o.commands.snippets=function(e){"use strict";return-1===["htmlmixed","javascript","css",l.less,l.sass,l.scss].indexOf(e.options.mode)?o.simpleHint(e,o.hint.anyword):oldCodeMirror?oldCodeMirror.snippets(e):s.mobile?void 0:o.snippets(e)};var c=function(t,i){"use strict";var a=this,d=null,p={},h=t,u=e('<div class="stretch panelwrapper"></div>');if(a.settings=i=i||{},a.id=a.name=t,(d=e(".panel."+t)).data("name",t),a.$el=d.detach(),a.$el.appendTo(u),u.appendTo(n),a.$panel=a.$el,a.$el=a.$el.parent().hide(),a.el=document.getElementById(t),a.order=++c.order,a.label=i.label||t,a.$el.data("panel",a),this._eventHandlers={},a.on("show",panels.updateQuery),a.on("hide",panels.updateQuery),1===a.order&&(i.nosplitter=!0),i.editor){if(p={parserfile:[],readOnly:!!s.state.embed&&"nocursor",dragDrop:!1,mode:l[h],lineWrapping:!1,theme:s.settings.theme||"jsbin",highlightLine:!0},e.extend(p,s.settings.editor||{}),p.extraKeys={},p.extraKeys.Tab="javascript"===t?"autocomplete":"snippets","html"===t&&e.extend(p,{syntax:t,profile:t}),"string"==typeof p.tabSize&&(p.tabSize=parseInt(p.tabSize,10)||2),"string"==typeof p.indentUnit&&(p.indentUnit=parseInt(p.indentUnit,10)||2),a.editor=o.fromTextArea(a.el,p),a.editor.on("highlightLines",function(){window.location.hash=panels.getHighlightLines()}),a.editor.on("change",function(e,t){return s.saveDisabled?r.trigger("codeChange.live",[{panelId:a.id,revert:!0,origin:t.origin}]):r.trigger("codeChange",[{panelId:a.id,revert:!0,origin:t.origin}]),!0}),a.editor.on("focus",function(){a.focus()}),"javascript"===t){var g="mac"===e.browser.platform?"Cmd":"Ctrl",f={};f[g+"-D"]="deleteLine",f[g+"-/"]=function(e){o.commands.toggleComment(e)},f.name="noEmmet",a.editor.addKeyMap(f)}a._setupEditor(a.editor,t)}e("html").is(".layout")?(a.splitter=e(),a.$el.removeClass("stretch")):i.nosplitter?a.splitter=e():(a.splitter=a.$el.splitter({}).data("splitter"),a.splitter.hide()),s.state.processors&&s.state.processors[t]?(h=s.state.processors[t],s.processors.set(a,s.state.processors[t])):i.processor?(h=i.processors[i.processor],s.processors.set(a,i.processor)):processors[a.id]?s.processors.set(a,a.id):a.processor=function(e){return new Promise(function(t){t(e)})},i.beforeRender&&r.bind("render",e.proxy(i.beforeRender,a)),i.editor||(a.ready=!0),s.state.embed,this.controlButton=e('<a role="button" class="button group" href="?'+t+'">'+a.label+"</a>"),this.updateAriaState(),this.controlButton.on("click touchstart",function(){return a.toggle(),!1}),this.controlButton.appendTo("#panels"),d.focus(function(){a.focus()}),s.mobile||d.add(this.$el.find(".label")).click(function(){a.focus()})};function p(e,i){if(e.codeSet)l=!0;else{var o=t.sessionStorage.getItem("jsbin.content."+i),n=s.embed?null:t.localStorage.getItem("saved-"+i),a=t.sessionStorage.getItem("url"),l=!1;if(a===s.getURL()||s.state.checksum||(t.sessionStorage.removeItem("checksum"),saveChecksum=!1),template&&o==template[i])e.setCode(o);else if(o&&a==s.getURL()&&a!==s.root)e.setCode(o),l=o!=n&&o!=template[i];else if(template.post||null===n||/(edit|embed)$/.test(window.location)||window.location.search)e.setCode(template[i]);else{e.setCode(n);var d=JSON.parse(t.localStorage.getItem("saved-processors")||"{}")[i];d&&s.processors.set(s.panels.panels[i],d)}e.editor&&e.editor.clearHistory&&e.editor.clearHistory()}l&&r.trigger("codeChange",[{revert:!1,onload:!0}])}c.order=0,c.prototype={virgin:!0,visible:!1,updateAriaState:function(){this.controlButton.attr("aria-label",this.label+" Panel: "+(this.visible?"Active":"Inactive"))},show:function(t){if(hideOpen(),!this.visible){r.trigger("history:close");var i=this,o=i.$el.find(".panel").length;if(analytics.showPanel(i.id),s.mobile&&panels.hideAll(!0),i.splitter.length){if(0===o||o>1)e(".panel."+i.id).show().closest(".panelwrapper").show();else i.$el.show();i.splitter.show()}else i.$el.show();if($body.addClass("panelsVisible"),i.settings.show&&i.settings.show.call(i,!0),i.controlButton.addClass("active"),i.visible=!0,this.updateAriaState(),s.mobile&&window.matchMedia&&window.matchMedia("(max-height: 410px) and (max-width: 640px)").matches&&i.editor&&i.editor.focus(),s.mobile)return i.focus(),void i.trigger("show");setTimeout(function(){if(a&&(void 0!==t?i.splitter.trigger("init",t):i.distribute()),i.editor){if(i.virgin){var o=i.$el.find(".label").outerHeight();o+=8,s.mobile||e(i.editor.scroller).find(".CodeMirror-lines").css("padding-top",o),p(i,i.name)}i.virgin&&!s.panels.ready||(i.editor.focus(),i.focus()),i.virgin&&i.settings.init&&setTimeout(function(){i.settings.init.call(i)},10)}else i.focus();r.trigger("sizeeditors"),i.trigger("show"),i.virgin=!1},0)}},hide:function(t){this.visible=!1,this.updateAriaState(),t?this.editor&&(getRenderedCode[this.id]=getRenderedCode.render(this.id)):analytics.hidePanel(this.id);var i=this.$el.find(".panel").length;if(0===i||i>1){var o=e(".panel."+this.id).hide();o.prev().hide(),0===o.closest(".panelwrapper").find(".panel:visible").length&&o.closest(".panelwrapper").hide()}else this.$el.hide(),this.splitter.hide();this.editor&&this.controlButton.toggleClass("hasContent",!!this.getCode().trim().length),this.controlButton.removeClass("active"),this.settings.hide&&this.settings.hide.call(this,!0);var n=s.panels.getVisible();n.length&&(s.panels.focused=n[0],s.panels.focused.editor?s.panels.focused.editor.focus():s.panels.focused.$el.focus(),s.panels.focused.focus()),!t&&s.mobile&&0===n.length&&(r.trigger("history:load"),e("#history").show(),setTimeout(function(){$body.removeClass("panelsVisible")},100)),this.trigger("hide"),t||(this.distribute(),r.trigger("sizeeditors"),r.trigger("history:open"))},toggle:function(){this[this.visible?"hide":"show"]()},getCode:function(){if(this.editor)return d.lastIndex=0,this.editor.getCode().replace(d,"")},setCode:function(e){this.editor&&(void 0===e&&(e=""),this.controlButton.toggleClass("hasContent",!!e.trim().length),this.codeSet=!0,this.editor.setCode(e.replace(d,"")))},codeSet:!1,blur:function(){this.$panel.addClass("blur")},focus:function(){this.$panel.removeClass("blur"),s.panels.focus(this)},render:function(){"use strict";var e=[].slice.call(arguments),t=this;return new Promise(function(i,o){t.editor?t.processor(t.getCode()).then(i,o):t.visible&&t.settings.render&&(s.panels.ready&&t.settings.render.apply(t,e),i())})},init:function(){this.settings.init&&this.settings.init.call(this)},_setupEditor:function(){var i=t.sessionStorage.getItem("panel")||s.settings.focusedPanel,o=this,a=o.editor;a.setCode=function(e){try{a.setValue(e)}catch(e){}},a.getCode=function(){return a.getValue()},a.currentLine=function(){return a.getCursor().line},s.embed&&(a._focus=a.focus,a.focus=function(){}),a.id=o.name,a.win=a.getWrapperElement(),a.scroller=e(a.getScrollerElement());var l=o.$el.find(".label");-1===document.body.className.indexOf("ie6")&&l.length&&a.on("scroll",function(t){a.getScrollInfo().top>10?l.stop().animate({opacity:0},20,function(){e(this).hide()}):l.show().stop().animate({opacity:1},150)});r.bind("sizeeditors",function(){if(o.visible){var e=o.editor.scroller.closest(".panel").outerHeight(),t=0;t+=o.$el.find("details").filter(":visible").height()||0,s.lameEditor||a.scroller.height(e-t);try{a.refresh()}catch(e){}setTimeout(function(){n[0].style.paddingLeft="1px",setTimeout(function(){n[0].style.paddingLeft="0"},0)},0)}}),setTimeout(function(){o.ready=!0,p(o,o.name),i==o.name&&setTimeout(function(){if(o.focus(),o.visible&&!s.mobile&&!s.tablet){a.focus();for(var e=a.getCode().split("\n"),i=null,r=0;r<e.length;r++)if(null===i&&""===e[r].trim()){i=r;break}a.setCursor({line:1*(t.sessionStorage.getItem("line")||i||0),ch:1*(t.sessionStorage.getItem("character")||0)})}},110)},0)},populateEditor:function(){p(this,this.name)},on:function(e,t){return(this._eventHandlers[e]=this._eventHandlers[e]||[]).push(t),this},trigger:function(e){var t=[].slice.call(arguments,1);t.unshift({type:e});for(var s=this._eventHandlers[e],i=0;s&&s[i];)s[i++].apply(this,t);return this}};var h=function(){s.panels.ready&&editors.console.render()},u=e("#panels"),g=e("div.processorSelector").each(function(){var t=this.getAttribute("data-type"),i=e(this),o=i.closest(".label").find("strong a"),r=o.text();i.find("a").click(function(i){var n=s.panels.named[t],a=u.find('a[href$="'+t+'"]');i.preventDefault();var l=this.hash.substring(1),d=e(this).text(),c=e(this).data("label");"convert"!==l?(a.html(c||d),o.html("<span>"+d+"</span>"),l===t?(processors.reset(t),h()):processors.set(t,l,h)):(o.text(r),a.html(r),n.render().then(function(e){processors.reset(t),n.setCode(e)}))}).bind("select",function(s,i){if(i===this.hash.substring(1)){var r=u.find('a[href$="'+t+'"]'),n=e(this);o.html("<span>"+n.text()+"</span>"),r.html(n.data("label")||n.text())}})});return processors.set=function(e,t,i){var o;e instanceof c?e=(o=e).id:o=s.panels.named[e],s.state.processors||(s.state.processors={});var r=t&&l[t]||l[e],n="jsx"!==t;if(o){o.trigger("processor",t||"none"),t&&processors[t]?(s.state.processors[e]=t,o.processor=processors[t](function(){o.editor.setOption("mode",r),o.editor.setOption("smartIndent",n),g.find("a").trigger("select",[t]),i&&i()})):(o.editor.setOption("mode",r),o.editor.setOption("smartIndent",n),o.processor=defaultProcessor,s.state.processors[e]=e,delete o.type);var a=r;"javascript"===r&&(a="js"),"htmlmixed"===r&&(a="html"),o.editor.getOption("lint")&&o.editor.lintStop(),s.settings[a+"hint"]&&(o.editor.setOption("mode",r),"undefined"!=typeof hintingDone&&(o.editor.setOption("mode",r),hintingDone(o.editor)))}},processors.reset=function(e){processors.set(e)},i.editors.Panel=c});
//# sourceMappingURL=../sourcemaps/editors/panel.js.map
