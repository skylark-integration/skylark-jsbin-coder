{"version":3,"sources":["editors/library.js"],"names":["define","$","jsbin","coder","panels","$library","groups","createHTMLToJadeTagConverter","tagName","attribute","suffix","regExToGrabResource","RegExp","html","resource","match","bind","i","j","library","groupOrder","group","groupLabel","lcGroup","empty","libraries","length","toLowerCase","replace","indexOf","label","key","push","join","trigger","this","value","selected","split","analytics","urls","isArray","attrList","attrs","url","code","named","getCode","state","line","editor","currentLine","character","getCursor","ch","add","file","scriptDefaultAttrs","cssDefaultAttrs","rel","type","attr","isPlainObject","pop","extend","isCssFile","isJadeActive","htmlLinkToJade","htmlScriptToJade","indent","trim","codeLines","splice","setCode","setCursor","insertResources","snippet","insertSnippet","on","parseLink","processors","lastIndexOf"],"mappings":"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","file":"../../editors/library.js","sourcesContent":["define([\r\n  \"skylark-jquery\",\r\n   \"../jsbin\",\r\n   \"../coder\",\r\n   \"./panels\"\r\n],function ($,jsbin,coder,panels) {\r\n  /*global $:true, editors:true, libraries:true, analytics:true */\r\n  // 'use strict'; // this causes bigger issues :-\\\r\n\r\n  var $library = $('#library, #alt-library'),\r\n      groups = {};\r\n\r\n  $library.bind('init', function () {\r\n    var i = 0,\r\n      j = 0,\r\n      k = 0,\r\n      library = {},\r\n      groupOrder = [],\r\n      group = {},\r\n      groupLabel = '',\r\n      lcGroup = '';\r\n\r\n    // reset\r\n    groups = {};\r\n    $library.empty();\r\n\r\n    for (i = 0; i < libraries.length; i++) {\r\n      library = libraries[i];\r\n      groupLabel = library.group || 'Other';\r\n      lcGroup = groupLabel.toLowerCase().replace(/[^a-z0-9]/ig, '');\r\n      if (groupOrder.indexOf(lcGroup) === -1) {\r\n        group = { label: groupLabel, libraries: [], key: lcGroup };\r\n        groups[lcGroup] = group;\r\n        groupOrder.push(lcGroup);\r\n      } else {\r\n        group = groups[lcGroup];\r\n      }\r\n\r\n      group.libraries.push(library);\r\n    }\r\n\r\n    var html = ['<option value=\"none\">None</option>'];\r\n\r\n    for (i = 0; i < groupOrder.length; i++) {\r\n      group = groups[groupOrder[i]];\r\n      html.push('<option value=\"\" data-group=\"' + group.label + '\" class=\"heading\">-------------</option>');\r\n\r\n      for (j = 0; j < group.libraries.length; j++) {\r\n        library = group.libraries[j];\r\n        html.push('<option value=\"' + group.key + ':' + j + '\">' + library.label + '</option>');\r\n      }\r\n    }\r\n\r\n    $library.html( html.join('') );\r\n  }).trigger('init');\r\n\r\n\r\n  $library.bind('change', function () {\r\n    if (!this.value) { return; }\r\n\r\n    var selected = this.value.split(':'),\r\n        group = groups[selected[0]],\r\n        library = group.libraries[selected[1]];\r\n\r\n    analytics.library('select', group.libraries[selected[1]].label);\r\n    insertResources(library.url);\r\n    if (library.snippet) {\r\n      insertSnippet(library.snippet);\r\n    }\r\n  }).on('click', function () {\r\n    analytics.library('open');\r\n  });\r\n\r\n  function insertResources(urls) {\r\n    if (!$.isArray(urls)) {\r\n      urls = [urls];\r\n    }\r\n\r\n    var i = 0,\r\n        length = urls.length,\r\n        url = '',\r\n        code = panels.named.html.getCode(), // editors => panels.named\r\n        state = { line: panels.named.html.editor.currentLine(), // editors => panels.named\r\n          character: panels.named.html.editor.getCursor().ch, // editors => panels.named\r\n          add: 0\r\n        },\r\n        html = [],\r\n        file = '',\r\n        resource,\r\n        attrList,\r\n        attrs,\r\n        scriptDefaultAttrs = {},\r\n        cssDefaultAttrs = { 'rel': 'stylesheet', 'type': 'text/css' };\r\n\r\n    for (i = 0; i < length; i++) {\r\n      url = urls[i];\r\n\r\n      // URLs can be objects carrying desired attributes\r\n      // The main resource (src, href) property is always 'url'\r\n      if ($.isPlainObject(url)) {\r\n        attrs = url;\r\n        url = url.url;\r\n        delete attrs.url;\r\n      } else {\r\n        attrs = {};\r\n      }\r\n\r\n      file = url.split('/').pop();\r\n\r\n      // Introduce any default attrs and flatten into a list for insertion\r\n      attrs = $.extend({}, (isCssFile(file) ? cssDefaultAttrs : scriptDefaultAttrs), attrs);\r\n      attrList = '';\r\n      for (var attr in attrs) {\r\n        attrList += ' ' + attr + '=\"' + attrs[attr] + '\"';\r\n      }\r\n\r\n      if (file && code.indexOf(file + '\"')) {\r\n        // attempt to lift out similar scripts\r\n        if (isCssFile(file)) {\r\n          code = code.replace(new RegExp('<link.*href=\".*?/' + file + '\".*?/>\\n?'), '');\r\n        } else {\r\n          code = code.replace(new RegExp('<script.*src=\".*?/' + file + '\".*?><' + '/script>\\n?'), '');\r\n        }\r\n        state.add--;\r\n      }\r\n\r\n      if (isCssFile(url)) {\r\n        resource = '<' + 'link href=\"' + url + '\"' + attrList  + ' />';\r\n      } else {\r\n        resource = '<' + 'script src=\"' + url + '\"' + attrList + '><' + '/script>';\r\n      }\r\n\r\n      if (isJadeActive()) {\r\n        resource = isCssFile(url) ? htmlLinkToJade(resource) : htmlScriptToJade(resource);\r\n      }\r\n\r\n      html.push(resource);\r\n\r\n      state.add++;\r\n    }\r\n\r\n    if (isJadeActive()) {\r\n      // always append Jade at the end, it's just easier that way...okay?\r\n      var indent = (code.match(/html.*\\n(\\s*)\\S?/i) || [,])[1];\r\n      code = code.trim() + '\\n' + indent + html.join('\\n' + indent).trim();\r\n    } else {\r\n      if (code.indexOf('<head') !== -1) {\r\n        var codeLines = code.split('\\n');\r\n        codeLines.splice(state.line, 0, html.join('\\n'));\r\n        code = codeLines.join('\\n');\r\n      } else { // add to the start of the doc\r\n        code = html.join('\\n') + code;\r\n      }\r\n    }\r\n\r\n    panels.named.html.setCode(code); // editors => panels.named\r\n    panels.named.html.editor.setCursor({ line: state.line + state.add, ch: state.character }); // editors => panels.named\r\n\r\n  }\r\n\r\n  function insertSnippet(snippet) {\r\n    var code = panels.named.html.getCode(), // editors => panels.named\r\n        state = { line: panels.named.html.editor.currentLine(),\r\n          character: panels.named.html.editor.getCursor().ch,\r\n          add: 0\r\n        };\r\n\r\n    if (code.indexOf('</head') !== -1) {\r\n      code = code.replace(/<\\/head>/i, snippet + '\\n</head>');\r\n    } else { // add to the start of the doc\r\n      code = snippet + '\\n' + code;\r\n    }\r\n\r\n    panels.named.html.setCode(code); // editors => panels.named\r\n    panels.named.html.editor.setCursor({ line: state.line + state.add, ch: state.character }); // editors => panels.named\r\n  }\r\n\r\n  function createHTMLToJadeTagConverter(tagName, attribute, suffix){\r\n    var regExToGrabResource = new RegExp(attribute+'=(\\'|\").+.'+suffix+'\\\\1');\r\n    return function(html){\r\n      var resource = html.match(regExToGrabResource);\r\n      return tagName+'('+resource[0]+')';\r\n    };\r\n  }\r\n\r\n  var htmlScriptToJade = createHTMLToJadeTagConverter('script', 'src', 'js');\r\n  // Dirty, but good enough for now, parse the link and add commas between attributes;\r\n  var htmlLinkToJade = (function(){\r\n    var parseLink = createHTMLToJadeTagConverter('link', 'href', 'css');\r\n    return function(html){\r\n      var jadeLink = parseLink(html);\r\n      return jadeLink.split('\" ').join('\",');\r\n    };\r\n  }());\r\n\r\n  function isJadeActive(){\r\n    return jsbin.state.processors.html === 'jade';\r\n  }\r\n\r\n  function isCssFile(url) {\r\n    return (url.length - (url.lastIndexOf('.css') + 4) === 0);\r\n  }\r\n\r\n  \r\n});"]}