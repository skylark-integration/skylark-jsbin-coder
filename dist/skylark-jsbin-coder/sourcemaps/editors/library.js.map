{"version":3,"sources":["editors/library.js"],"names":["define","$","jsbin","coder","panels","libraries","analytics","$library","groups","createHTMLToJadeTagConverter","tagName","attribute","suffix","regExToGrabResource","RegExp","html","resource","match","bind","i","j","library","groupOrder","group","groupLabel","lcGroup","empty","length","toLowerCase","replace","indexOf","label","key","push","join","trigger","this","value","selected","split","urls","isArray","attrList","attrs","url","code","named","getCode","state","line","editor","currentLine","character","getCursor","ch","add","file","scriptDefaultAttrs","cssDefaultAttrs","rel","type","attr","isPlainObject","pop","extend","isCssFile","isJadeActive","htmlLinkToJade","htmlScriptToJade","indent","trim","codeLines","splice","setCode","setCursor","insertResources","snippet","insertSnippet","on","parseLink","processors","lastIndexOf"],"mappings":"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","file":"../../editors/library.js","sourcesContent":["define([\r\n  \"skylark-jquery\",\r\n   \"../jsbin\",\r\n   \"../coder\",\r\n   \"./panels\",\r\n   \"./libraries\",\r\n  \"../chrome/analytics\"\r\n\r\n],function ($,jsbin,coder,panels, libraries, analytics) {\r\n  /*global $:true, editors:true, libraries:true, analytics:true */\r\n  // 'use strict'; // this causes bigger issues :-\\\r\n\r\n  var $library = $('#library, #alt-library'),\r\n      groups = {};\r\n\r\n  $library.bind('init', function () {\r\n    var i = 0,\r\n      j = 0,\r\n      k = 0,\r\n      library = {},\r\n      groupOrder = [],\r\n      group = {},\r\n      groupLabel = '',\r\n      lcGroup = '';\r\n\r\n    // reset\r\n    groups = {};\r\n    $library.empty();\r\n\r\n    for (i = 0; i < libraries.length; i++) {\r\n      library = libraries[i];\r\n      groupLabel = library.group || 'Other';\r\n      lcGroup = groupLabel.toLowerCase().replace(/[^a-z0-9]/ig, '');\r\n      if (groupOrder.indexOf(lcGroup) === -1) {\r\n        group = { label: groupLabel, libraries: [], key: lcGroup };\r\n        groups[lcGroup] = group;\r\n        groupOrder.push(lcGroup);\r\n      } else {\r\n        group = groups[lcGroup];\r\n      }\r\n\r\n      group.libraries.push(library);\r\n    }\r\n\r\n    var html = ['<option value=\"none\">None</option>'];\r\n\r\n    for (i = 0; i < groupOrder.length; i++) {\r\n      group = groups[groupOrder[i]];\r\n      html.push('<option value=\"\" data-group=\"' + group.label + '\" class=\"heading\">-------------</option>');\r\n\r\n      for (j = 0; j < group.libraries.length; j++) {\r\n        library = group.libraries[j];\r\n        html.push('<option value=\"' + group.key + ':' + j + '\">' + library.label + '</option>');\r\n      }\r\n    }\r\n\r\n    $library.html( html.join('') );\r\n  }).trigger('init');\r\n\r\n\r\n  $library.bind('change', function () {\r\n    if (!this.value) { return; }\r\n\r\n    var selected = this.value.split(':'),\r\n        group = groups[selected[0]],\r\n        library = group.libraries[selected[1]];\r\n\r\n    analytics.library('select', group.libraries[selected[1]].label);\r\n    insertResources(library.url);\r\n    if (library.snippet) {\r\n      insertSnippet(library.snippet);\r\n    }\r\n  }).on('click', function () {\r\n    analytics.library('open');\r\n  });\r\n\r\n  function insertResources(urls) {\r\n    if (!$.isArray(urls)) {\r\n      urls = [urls];\r\n    }\r\n\r\n    var i = 0,\r\n        length = urls.length,\r\n        url = '',\r\n        code = panels.named.html.getCode(), // editors => panels.named\r\n        state = { line: panels.named.html.editor.currentLine(), // editors => panels.named\r\n          character: panels.named.html.editor.getCursor().ch, // editors => panels.named\r\n          add: 0\r\n        },\r\n        html = [],\r\n        file = '',\r\n        resource,\r\n        attrList,\r\n        attrs,\r\n        scriptDefaultAttrs = {},\r\n        cssDefaultAttrs = { 'rel': 'stylesheet', 'type': 'text/css' };\r\n\r\n    for (i = 0; i < length; i++) {\r\n      url = urls[i];\r\n\r\n      // URLs can be objects carrying desired attributes\r\n      // The main resource (src, href) property is always 'url'\r\n      if ($.isPlainObject(url)) {\r\n        attrs = url;\r\n        url = url.url;\r\n        delete attrs.url;\r\n      } else {\r\n        attrs = {};\r\n      }\r\n\r\n      file = url.split('/').pop();\r\n\r\n      // Introduce any default attrs and flatten into a list for insertion\r\n      attrs = $.extend({}, (isCssFile(file) ? cssDefaultAttrs : scriptDefaultAttrs), attrs);\r\n      attrList = '';\r\n      for (var attr in attrs) {\r\n        attrList += ' ' + attr + '=\"' + attrs[attr] + '\"';\r\n      }\r\n\r\n      if (file && code.indexOf(file + '\"')) {\r\n        // attempt to lift out similar scripts\r\n        if (isCssFile(file)) {\r\n          code = code.replace(new RegExp('<link.*href=\".*?/' + file + '\".*?/>\\n?'), '');\r\n        } else {\r\n          code = code.replace(new RegExp('<script.*src=\".*?/' + file + '\".*?><' + '/script>\\n?'), '');\r\n        }\r\n        state.add--;\r\n      }\r\n\r\n      if (isCssFile(url)) {\r\n        resource = '<' + 'link href=\"' + url + '\"' + attrList  + ' />';\r\n      } else {\r\n        resource = '<' + 'script src=\"' + url + '\"' + attrList + '><' + '/script>';\r\n      }\r\n\r\n      if (isJadeActive()) {\r\n        resource = isCssFile(url) ? htmlLinkToJade(resource) : htmlScriptToJade(resource);\r\n      }\r\n\r\n      html.push(resource);\r\n\r\n      state.add++;\r\n    }\r\n\r\n    if (isJadeActive()) {\r\n      // always append Jade at the end, it's just easier that way...okay?\r\n      var indent = (code.match(/html.*\\n(\\s*)\\S?/i) || [,])[1];\r\n      code = code.trim() + '\\n' + indent + html.join('\\n' + indent).trim();\r\n    } else {\r\n      if (code.indexOf('<head') !== -1) {\r\n        var codeLines = code.split('\\n');\r\n        codeLines.splice(state.line, 0, html.join('\\n'));\r\n        code = codeLines.join('\\n');\r\n      } else { // add to the start of the doc\r\n        code = html.join('\\n') + code;\r\n      }\r\n    }\r\n\r\n    panels.named.html.setCode(code); // editors => panels.named\r\n    panels.named.html.editor.setCursor({ line: state.line + state.add, ch: state.character }); // editors => panels.named\r\n\r\n  }\r\n\r\n  function insertSnippet(snippet) {\r\n    var code = panels.named.html.getCode(), // editors => panels.named\r\n        state = { line: panels.named.html.editor.currentLine(),\r\n          character: panels.named.html.editor.getCursor().ch,\r\n          add: 0\r\n        };\r\n\r\n    if (code.indexOf('</head') !== -1) {\r\n      code = code.replace(/<\\/head>/i, snippet + '\\n</head>');\r\n    } else { // add to the start of the doc\r\n      code = snippet + '\\n' + code;\r\n    }\r\n\r\n    panels.named.html.setCode(code); // editors => panels.named\r\n    panels.named.html.editor.setCursor({ line: state.line + state.add, ch: state.character }); // editors => panels.named\r\n  }\r\n\r\n  function createHTMLToJadeTagConverter(tagName, attribute, suffix){\r\n    var regExToGrabResource = new RegExp(attribute+'=(\\'|\").+.'+suffix+'\\\\1');\r\n    return function(html){\r\n      var resource = html.match(regExToGrabResource);\r\n      return tagName+'('+resource[0]+')';\r\n    };\r\n  }\r\n\r\n  var htmlScriptToJade = createHTMLToJadeTagConverter('script', 'src', 'js');\r\n  // Dirty, but good enough for now, parse the link and add commas between attributes;\r\n  var htmlLinkToJade = (function(){\r\n    var parseLink = createHTMLToJadeTagConverter('link', 'href', 'css');\r\n    return function(html){\r\n      var jadeLink = parseLink(html);\r\n      return jadeLink.split('\" ').join('\",');\r\n    };\r\n  }());\r\n\r\n  function isJadeActive(){\r\n    return jsbin.state.processors.html === 'jade';\r\n  }\r\n\r\n  function isCssFile(url) {\r\n    return (url.length - (url.lastIndexOf('.css') + 4) === 0);\r\n  }\r\n\r\n  \r\n});"]}